{% extends "base.html" %}
{% load static %}
{% block title %}{{ room.name }}{% endblock %}

{% block extra_head %}
<script src="{% static 'chat/chat.js' %}"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center page-head">
  <div>
    {% if role == "OWNER" %}
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0" id="room-name">{{ room.name }}</h2>
        <button type="button" class="btn btn-outline-light btn-sm rename-toggle" aria-label="Renommer le salon">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 20h9"/>
            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
          </svg>
        </button>
      </div>
      <form method="post" action="{% url 'room_rename' room.id %}" class="rename-form">
        {% csrf_token %}
        <div class="d-flex gap-2 align-items-center">
          <input name="name" class="form-control form-control-sm rename-input" value="{{ room.name }}" maxlength="80" aria-label="Nom du salon">
          <button type="submit" class="btn btn-outline-primary btn-sm">Valider</button>
          <button type="button" class="btn btn-outline-secondary btn-sm rename-cancel">Annuler</button>
        </div>
      </form>
    {% else %}
      <h2 class="mb-0" id="room-name">{{ room.name }}</h2>
    {% endif %}
    <small class="text-muted">
      Ton rôle:
      <span id="current-role">
        {% if role == "MOD" %}Modérateur{% elif role == "MEMBER" %}Membre{% elif role == "OWNER" %}Créateur{% else %}{{ role }}{% endif %}
      </span>
    </small>
  </div>
  <div class="d-flex gap-2">
    {% if role == "OWNER" %}
      <form method="post" action="{% url 'room_delete' room.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger">Supprimer le salon</button>
      </form>
    {% endif %}
    <a class="btn btn-outline-secondary" href="{% url 'room_list' %}">&larr; Retour</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-2">Membres</h5>
        <div id="members-list">
          {% regroup memberships by role as memberships_by_role %}
          {% for group in memberships_by_role %}
            <div class="member-role-block">
              <div class="member-role-title">
                {% if group.grouper == "OWNER" %}Créateur{% elif group.grouper == "MOD" %}Modérateur{% elif group.grouper == "MEMBER" %}Membres{% elif group.grouper == "BANNED" %}Bannis{% else %}{{ group.grouper }}{% endif %}
              </div>
              <div class="list-group">
                {% for mem in group.list %}
                  <div class="list-group-item member-row d-flex flex-column {% if mem.role == "BANNED" %}opacity-50{% endif %}">
                    <div class="member-name">
                      <strong>{{ mem.user.username }}</strong>
                    </div>
                    <div class="member-actions">
                      {% if role == "OWNER" and mem.role != "OWNER" and mem.user.id != user.id %}
                        {% if mem.role == "MOD" %}
                          <form method="post" action="{% url 'unset_moderator' room.id mem.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-secondary member-action-btn">Retirer modérateur</button>
                          </form>
                        {% elif mem.role != "BANNED" %}
                          <form method="post" action="{% url 'set_moderator' room.id mem.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-primary member-action-btn">Mettre modérateur</button>
                          </form>
                        {% endif %}
                      {% endif %}
                      {% if role == "OWNER" or role == "MOD" %}
                        {% if mem.role == "BANNED" and role == "OWNER" %}
                          <form method="post" action="{% url 'unban_user' room.id mem.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-success member-action-btn">Débannir</button>
                          </form>
                        {% elif mem.role != "OWNER" and mem.user.id != user.id %}
                          <form method="post" action="{% url 'ban_user' room.id mem.user.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger member-action-btn">Bannir</button>
                          </form>
                        {% endif %}
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div id="chat-box" class="border rounded p-3" style="height: 380px; overflow-y: auto;">
          {% for m in chat_messages %}
            {% if m.content|slice:":8" == "[SYSTEM]" %}
              <div class="mb-2 message-system" data-id="{{ m.id }}">
                <div class="message-text">
                  {% if m.is_deleted %}[message supprimé]{% else %}{{ m.content|cut:"[SYSTEM] " }}{% endif %}
                </div>
              </div>
            {% else %}
              <div class="mb-2 {% if m.author_id == user.id %}message-own{% else %}message-other{% endif %}" data-id="{{ m.id }}">
                <strong>{{ m.author.username }} : </strong>
                <div class="message-text">
                  {% if m.is_deleted %}[message supprimé]{% else %}{{ m.content }}{% endif %}
                </div>
                <div class="message-meta text-muted">
                  <span>{{ m.created_at|date:"d/m/Y H:i" }}</span>
                  {% if role == "OWNER" or role == "MOD" or m.author_id == user.id %}
                    {% if not m.is_deleted %}
                      <button class="btn btn-sm btn-link text-danger p-0 ms-2 delete-btn" data-id="{{ m.id }}" aria-label="Supprimer">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 6h18"/>
                          <path d="M8 6V4h8v2"/>
                          <path d="M6 6l1 14h10l1-14"/>
                          <path d="M10 11v6"/>
                          <path d="M14 11v6"/>
                        </svg>
                      </button>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <div id="typing-indicator" class="mt-2 mb-1"></div>

        <div class="mt-1 d-flex gap-2">
          <input id="msg-input" class="form-control" placeholder="Ecris un message">
          <button id="send-btn" class="btn btn-primary">Envoyer</button>
        </div>

        <div class="mt-2 d-flex gap-2 flex-wrap">
          <!-- mini picker emojis -->
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128512;">&#128512;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128514;">&#128514;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128525;">&#128525;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#129300;">&#129300;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128526;">&#128526;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128517;">&#128517;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128557;">&#128557;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128293;">&#128293;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#10024;">&#10024;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#128077;">&#128077;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#127881;">&#127881;</button>
          <button class="btn btn-sm btn-outline-secondary emoji-btn" data-emoji="&#10084;">&#10084;</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.CHAT_CONFIG = {
    roomId: {{ room.id }},
    roomDetailUrl: "{% url 'room_detail' room.id %}",
    apiMessagesUrl: "{% url 'api_messages' room.id %}",
    apiSendUrl: "{% url 'api_send_message' room.id %}",
    apiDeleteBase: "{% url 'api_delete_message' room.id 0 %}".replace("/0/", "/"),
    apiRoomStateUrl: "{% url 'api_room_state' room.id %}",
    apiTypingUrl: "{% url 'api_typing' room.id %}",
    apiBanBase: "{% url 'ban_user' room.id 0 %}".replace("/0/", "/"),
    apiUnbanBase: "{% url 'unban_user' room.id 0 %}".replace("/0/", "/"),
    apiModBase: "{% url 'set_moderator' room.id 0 %}".replace("/0/", "/"),
    apiUnmodBase: "{% url 'unset_moderator' room.id 0 %}".replace("/0/", "/"),
    csrfToken: "{{ csrf_token }}",
    currentUser: "{{ user.username|escapejs }}",
    currentUserId: {{ user.id }},
  };

  document.addEventListener("click", function (event) {
    const toggle = event.target.closest(".rename-toggle");
    if (toggle) {
      const form = document.querySelector(".rename-form");
      if (!form) return;
      form.classList.toggle("is-open");
      const input = form.querySelector(".rename-input");
      if (input && form.classList.contains("is-open")) {
        input.focus();
        input.select();
      }
      return;
    }
    const cancel = event.target.closest(".rename-cancel");
    if (cancel) {
      const form = cancel.closest(".rename-form");
      if (form) form.classList.remove("is-open");
    }
  });
</script>
{% endblock %}
